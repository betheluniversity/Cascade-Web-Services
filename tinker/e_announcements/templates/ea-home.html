{% extends "tinker_base.html" %}

{% set title = 'E-Announcements' %}

{% block styles %}
    <style type="text/css">
    </style>
{% endblock %}

{% block page_title %}Bethel University Tinker{% endblock %}

{% block main_content %}
    <div class="content">
        <div class="container-fluid">
            <div class="col-md-12">
                <p class="description">Click the button below to create a new E-Announcement</p>
                <a href="{{ url_for('e_announcements.EAnnouncementsView:new') }}" class="btn btn-primary new-btn">Submit
                    New E-Announcement</a>
                <p class="description">Below is the list of E-Announcements you have access to edit.</p>
                <p class="description">The below are optional parameters to help in your search.</p>
                <div>
                    <small>Used by entering in part of a name, for example "scho" will select E-Announcements with
                        words "scholar", "school", "scholastic" etc.</small>
                    <label for="annzTitle">E-Announcement Title:</label>
                        <input id="annzTitle" type="text" name="annzTitle"><br/>
                    <small>The Start and End fields are to specify the date range where an announcment might fall,
                        for example "New Years Eve" and "Christmas" would both show up if you started at December 25th
                        and ended on December 31st</small>
                    <label for="annzStart">Start Date:</label>
                        <input id="annzStart" class='datepicker' size='11'/>
                    <label for="annzEnd">End Date:</label>
                        <input id="annzEnd" class='datepicker' size='11'/>
                    <a type="submit" id="e-announcement-submit-btn" class="btn btn-primary search-announcements">Search</a>
                </div>
                <hr/>
                {# spinner placeholder #}
                <div id="spinner" class="spinner" style="display:none;">
                    <img id="img-spinner" src="https://cdn1.bethel.edu/images/load.gif" alt="Loading"/>
                </div>
                <div id="results">
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {#  Script to do Bethel E-Announcements fancyness for blacking out dates to pick  #}
{#    <script type="text/javascript" src="E-Announcements-pikaday.js"></script>#}
    {#  Script to update the modal submit to delete the correct form#}
    <link rel="stylesheet" href="{{ url_for('static', filename='pikaday.css') }}">
    <script src="{{ url_for('static', filename='pikaday.js') }}"></script>
    <script src="{{ url_for('static', filename='pikaday.jquery.js') }}"></script>
    <script language="javascript" type="text/javascript" src="/static/blackout-dates.js"></script>
    <script type="text/javascript">

        $('.datepicker').each(function () {
            var current_element = $(this);
            var starting_values = {
                field: this,
                format: 'MM DD YYYY',
                minDate: new Date('2000-01-01'),
                maxDate: new Date('2040-12-31'),
                yearRange: [2000, 2040],
                disableDayFn: function (date) {
                    var start_populated = $("#annzStart").val();
                    var end_populated = $("#annzEnd").val();
                    var today = new Date();
                    if(start_populated == "" && end_populated == ""){
                        return null;
                    }else if(start_populated != "" && current_element.attr('id') == 'annzEnd'){
                        if(new Date(start_populated) >= date){
                            return date;
                        }
                    }else if(end_populated != "" && current_element.attr('id') == 'annzStart'){
                        if(new Date(end_populated) <= date){
                            return date;
                        }
                    }
                    // remove all Sun/Tues/Thur/Sat days from the week
                    if ($.inArray(date.getDay(), [0, 2, 4, 6]) > -1 || is_date_a_bethel_holiday(date) ) {
                        return date;
                    }

                    // Find the previous business day at 1pm, continually searching back until you hit a MWF that is not a holiday
                    var dateCutoff = date;
                    dateCutoff.setDate(dateCutoff.getDate() - 1);

                    while (dateCutoff.getDay() == 0 || dateCutoff.getDay() == 6 || is_date_a_bethel_holiday(dateCutoff)) {
                        dateCutoff.setDate(dateCutoff.getDate() - 1);
                    }
                    dateCutoff.setHours(13);
                }
            };
            // if its the startDate, set default date to today
            if( $(this).attr('id') == 'annzStart' ) {
                starting_values['defaultDate'] = new Date();
                starting_values['setDefaultDate'] = true;
            }

            var picker = new Pikaday(starting_values);
        });
        $(".delete-press").click(function () {
            $("#modal-confirm").attr("href", "/e-announcements/delete/" + $(this).data('e-announcement-id'));
        });
        function search_announcements() {
            search_url = "{{ url_for('e_announcements.EAnnouncementsView:search') }}";
            $('#spinner').show();
            inputs = {
                "title": $("#annzTitle").val(),
                "start": $("#annzStart").val(),
                "end": $("#annzEnd").val(),
{#                Add in the school selector with the drop down later on when everything is working#}
{#                "selection": $("#school-selector").val()#}
            };
            $.ajax({
                type: "POST",
                url: search_url,
                data: JSON.stringify(inputs),
                contentType: 'application/json;charset=UTF-8',
                success: function (result) {
                    // window.location.replace(result);
                    document.getElementById('results').innerHTML = result;
{#                    $('#results').val(result);#}
                    $('#spinner').hide();
                }
            });
        }
        $(".search-announcements").click(function () {
            search_announcements();
        });
        search_announcements();
    </script>

{% endblock %}


